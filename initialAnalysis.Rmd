---
title: "initialAnalysis"
output: html_document
---

```{r setup, include=FALSE}
# #reference genome 
# library(BSgenome.Mmusculus.UCSC.mm10)
# 
# #annotations
# library(org.Mm.eg.db)

#creating count matrix
library(tximeta)
library(BiocManager)
library(dplyr)
library(DESeq2)
```

## Protocol:

### 1. Use salmon to quantify transcripts
### 2. Use tximeta to get count matrix
### 3. use with DEseq for expression


import data table & create table with file paths to sample quant files
``` {r include = TRUE}

data_table = read.delim("data_table")

txdata = data_table %>% dplyr::select(c(SampleName, SampleGenotype, SampleTime, QuantFile)) %>%
  dplyr::rename(names = SampleName, files = QuantFile)

dirPath = "/active/allenspach_e/AllenspachRNASeqData/2022_SH2B3_TcellSeq/data/"

#rename files column to include full path

txdata = txdata %>% mutate(files = paste(dirPath, files, sep = ""))

#import quantifications
se = tximeta(data.frame(as_tibble(txdata)))

#get quants at gene level
gse = summarizeToGene(se)


# analyzedPath = "/active/allenspach_e/AllenspachRNASeqData/2022_SH2B3_TcellSeq/analyzed_data/"
# 
# #save datasets as RDS
# saveRDS(gse, paste(analyzedPath,"gse.rds", sep = ""))
# saveRDS(se, paste(analyzedPath,"se.rds", sep = ""))

```


```{r include = T}

#differential expression with DESeq2
dds = DESeqDataSet(gse, design = ~ SampleGenotype + SampleTime)

#filter out empty rows

#get empty rows
nonzero = rowSums(counts(dds)) > 1
dds = dds[nonzero, ]

#factor so genotypes are grouped together
dds$SampleGenotype = factor(dds$SampleGenotype, levels = c("WT", "KO")) %>%
  relevel(dds$SampleGenotype, ref = "WT")

```


```{r distMatrix, echo=FALSE}

library(PoiClaClu)
library(RColorBrewer)
poisd = PoissonDistance(t(counts(dds)))

samplePoisDistMatrix = as.matrix(poisd$dd)

colors <- colorRampPalette((brewer.pal(9, "Blues")) )(255)
rownames(samplePoisDistMatrix) = paste(dds$SampleGenotype, dds$SampleTime, sep = " - ")
colnames(samplePoisDistMatrix) = NULL
pheatmap::pheatmap(samplePoisDistMatrix, clustering_distance_rows = poisd$dd,
         clustering_distance_cols = poisd$dd, col = colors)
```


```{r PCAplots, include = T}

library(vsn)

#variance stabilizing transformation
vsd = vst(dds)
plotPCA(vsd, intgroup = c("SampleGenotype", "SampleTime"))
```




